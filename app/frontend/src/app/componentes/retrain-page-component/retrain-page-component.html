<div class="rounded-2xl border border-secondary-500/20 bg-slate-950/30 p-6 space-y-5">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
    <div>
      <div class="text-xl font-bold text-slate-100">Reentrenamiento Automático</div>
      <div class="text-xs text-slate-400">
        Ejecuta el notebook/pipeline y actualiza el modelo cuando termina.
      </div>
    </div>

    <button
      (click)="state.onRetrain()"
      [disabled]="state.retrainBusy || state.retrainParsed?.status === 'RUNNING'"
      class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl
             bg-gradient-to-r from-secondary-600 to-purple-600 text-white font-semibold
             hover:brightness-110 active:translate-y-[1px]
             disabled:opacity-50 transition"
    >
      <span class="inline-block" [class.animate-spin]="state.retrainBusy || state.retrainParsed?.status === 'RUNNING'">⟳</span>
      {{ (state.retrainBusy || state.retrainParsed?.status === 'RUNNING') ? 'Ejecutando…' : 'Reentrenar' }}
    </button>
  </div>

  <!-- Status Banner -->
  <div
    class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 flex items-start gap-3"
    [ngClass]="{
      'border-amber-500/30': state.retrainBusy && state.retrainParsed?.status !== 'RUNNING',
      'border-secondary-500/30': state.retrainParsed?.status === 'RUNNING',
      'border-emerald-500/30': state.retrainParsed?.status === 'DONE',
      'border-red-500/30': state.retrainParsed?.status === 'ERROR'
    }"
  >
    <!-- Dot -->
    <div
      class="mt-1 w-2.5 h-2.5 rounded-full"
      [ngClass]="{
        'bg-amber-400 animate-pulse': state.retrainBusy && state.retrainParsed?.status !== 'RUNNING',
        'bg-secondary-400 animate-pulse': state.retrainParsed?.status === 'RUNNING',
        'bg-emerald-400': state.retrainParsed?.status === 'DONE',
        'bg-red-400': state.retrainParsed?.status === 'ERROR',
        'bg-slate-600': !state.retrainBusy && state.retrainParsed?.status === 'IDLE'
      }"
    ></div>

    <div class="flex-1">
      <!-- Label -->
      <div class="text-sm font-semibold text-slate-200">
        <ng-container *ngIf="state.retrainParsed?.status === 'RUNNING'; else notRunning">
          Entrenamiento en progreso
        </ng-container>
        <ng-template #notRunning>
          <ng-container *ngIf="state.retrainBusy; else idleDoneErr">
            Preparando pipeline (ejecutando notebook)…
          </ng-container>
          <ng-template #idleDoneErr>
            <ng-container [ngSwitch]="state.retrainParsed?.status">
              <span *ngSwitchCase="'DONE'">Finalizado</span>
              <span *ngSwitchCase="'ERROR'">Error</span>
              <span *ngSwitchDefault>En espera</span>
            </ng-container>
          </ng-template>
        </ng-template>
      </div>

      <div class="text-xs text-slate-400 mt-1 leading-relaxed">
        <ng-container *ngIf="state.retrainParsed?.status === 'RUNNING'">
          Epoch {{ state.retrainParsed.epoch }} / {{ state.retrainParsed.epochsTotal || '—' }}
          · Loss: {{ state.retrainParsed.trainLoss ?? '—' }}
          · ETA: {{ state.retrainParsed.etaSec ? (state.retrainParsed.etaSec + ' s') : '—' }}
        </ng-container>

        <ng-container *ngIf="state.retrainBusy && state.retrainParsed?.status !== 'RUNNING'">
          Esto puede tardar mientras el notebook valida, prepara dataset y configura el entrenamiento.
        </ng-container>

        <ng-container *ngIf="!state.retrainBusy && state.retrainParsed?.status === 'IDLE'">
          Presiona “Reentrenar” para iniciar.
        </ng-container>

        <ng-container *ngIf="state.retrainParsed?.status === 'DONE'">
          Si el pipeline promovió una nueva versión, puedes recargar el modelo desde el header.
        </ng-container>

        <ng-container *ngIf="state.retrainParsed?.status === 'ERROR'">
          Revisa los logs inferiores o el JSON de resultado.
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Pre-training Loading Screen (antes de RUNNING) -->
  <div
    *ngIf="state.retrainBusy && state.retrainParsed?.status !== 'RUNNING'"
    class="rounded-2xl border border-amber-500/20 bg-amber-500/5 p-5"
  >
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-amber-500/15 border border-amber-500/20 flex items-center justify-center">
        <span class="inline-block animate-spin text-amber-300 text-lg">⟳</span>
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold text-slate-200">Ejecutando notebook / preparando entrenamiento…</div>
        <div class="text-xs text-slate-400 mt-1">
          Validación, dataset, cache, dependencias, registro en MLflow.
        </div>
      </div>
    </div>

    <!-- Skeleton steps -->
    <div class="mt-4 space-y-3">
      <div class="h-3 rounded bg-slate-800/70 overflow-hidden">
        <div class="h-3 w-2/3 bg-amber-500/20 animate-pulse"></div>
      </div>
      <div class="h-3 rounded bg-slate-800/70 overflow-hidden">
        <div class="h-3 w-1/2 bg-amber-500/20 animate-pulse"></div>
      </div>
      <div class="h-3 rounded bg-slate-800/70 overflow-hidden">
        <div class="h-3 w-3/4 bg-amber-500/20 animate-pulse"></div>
      </div>
    </div>

    <!-- Tip -->
    <div class="mt-4 text-xs text-slate-400">
      Si tarda mucho, revisa el panel de logs para ver en qué paso va.
    </div>
  </div>

  <!-- Training Progress (RUNNING) -->
  <div *ngIf="state.retrainParsed?.status === 'RUNNING'" class="rounded-2xl border border-secondary-500/20 bg-slate-950/40 p-5 space-y-4">

    <!-- Progress bar -->
    <div class="flex items-center justify-between text-sm">
      <div class="text-slate-300 font-semibold">Progreso</div>
      <div class="text-slate-400">
        {{ state.retrainParsed.epochsTotal ? ( (100 * state.retrainParsed.epoch / state.retrainParsed.epochsTotal) | number:'1.0-0') : 0 }}%
      </div>
    </div>

    <div class="h-3 bg-slate-800 rounded-full overflow-hidden">
      <div
        class="h-3 bg-gradient-to-r from-secondary-600 to-purple-600 transition-all"
        [style.width.%]="
          state.retrainParsed?.epochsTotal
            ? (100 * state.retrainParsed.epoch / state.retrainParsed.epochsTotal)
            : 0
        ">
      </div>
    </div>

    <!-- Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
        <div class="text-xs text-slate-500">Epoch</div>
        <div class="text-lg font-bold text-slate-100">{{ state.retrainParsed.epoch }}</div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
        <div class="text-xs text-slate-500">Total</div>
        <div class="text-lg font-bold text-slate-100">{{ state.retrainParsed.epochsTotal || '—' }}</div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
        <div class="text-xs text-slate-500">Train loss</div>
        <div class="text-lg font-bold text-slate-100">{{ state.retrainParsed.trainLoss ?? '—' }}</div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
        <div class="text-xs text-slate-500">ETA</div>
        <div class="text-lg font-bold text-slate-100">
          {{ state.retrainParsed.etaSec ? (state.retrainParsed.etaSec | number:'1.0-0') + ' s' : '—' }}
        </div>
      </div>
    </div>

    <!-- Raw training log (opcional) -->
    <details class="rounded-xl border border-slate-800 bg-slate-950/30 p-4">
      <summary class="cursor-pointer text-sm text-slate-300 font-semibold">
        Ver log de progreso (crudo)
      </summary>
      <pre class="text-xs bg-black p-3 rounded mt-3 overflow-auto max-h-64">{{ state.retrainTextLog }}</pre>
    </details>

  </div>

  <!-- Result JSON -->
  <details class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
    <summary class="cursor-pointer text-sm text-slate-300 font-semibold">
      Ver resultado del pipeline (JSON)
    </summary>
    <pre class="text-xs bg-black p-3 rounded mt-3 overflow-auto max-h-64">{{ state.retrainResult | json }}</pre>
  </details>

</div>
